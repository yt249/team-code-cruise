# CI pipeline for linting and tests
# - Lints the frontend React app using ESLint
# - Runs backend and frontend unit tests using Jest

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    # Run all shell commands from the frontend folder by default
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20 and enable npm cache
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm
          # Use the frontend's lockfile for cache key
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm install

      - name: Run ESLint
        run: npm run lint
        # If you want lint to only warn (not fail CI), add: --max-warnings=0

  frontend-test:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    # Run all shell commands from the frontend folder by default
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20 and enable npm cache
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm
          # Use the frontend's lockfile for cache key
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies (allow new Jest deps without lock update)
        run: npm install

      - name: Run frontend unit tests (with coverage)
        run: npm run test:ci

  backend-test:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    # Run all shell commands from the backend folder by default
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20 and enable npm cache
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm
          # Use the backend's lockfile for cache key
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies (no lockfile present; allow new deps)
        run: npm install

      - name: Generate Prisma client
        run: npm run prisma:gen
        # Ensure Prisma client is generated for any code paths that import it

      - name: Run unit tests (with coverage)
        run: npm run test:ci
        # The test script sets RB_DATA_MODE=memory and JWT_SECRET=test-secret internally
